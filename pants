#! /usr/bin/env python2.7

# pants


import inspect
import os.path
import sys

# Add <root>/src/python to the import path so we can use standard Foursquare modules.
root_dir = os.path.dirname(inspect.getfile(inspect.currentframe()))
def path(*p): return os.path.join(root_dir, *p)
python_dir = path("src", "python")
sys.path.insert(0, python_dir)

from argparse import ArgumentParser
from foursquare.common.json_config import JsonConfig
from foursquare.common.process import run_command
from foursquare.toolchain.pants import PantsRunner
import os
import sys
import platform


config = JsonConfig(path('.fsconfig.json'))
runner = PantsRunner(root_dir, config, quiet=True)

parser = ArgumentParser(add_help=False)
runner.setup_arg_parser(parser)
parser.add_argument('goal', nargs='?')
parser.add_argument('--skip-upkeep', action='store_true', default=False)

def main():
  mac_ver = platform.mac_ver()[0]
  if mac_ver[0:4] in ('10.7', '10.8'):
    print '*' * 100
    print "Pants requires osx 10.9. Contact helpdesk@ or upgrade via App Store."
    print '*' * 100
    sys.exit(1)


  args = args, other_args = parser.parse_known_args()
  args.passthrough = other_args

  if not args.skip_upkeep:
    ret = run_command(['./scripts/upkeep/check.sh'], quiet=True)
    if not ret:
      exit(ret)

  ret = runner.run(args.goal, args)
  if '--help' in other_args:
    runner.print_help(args.goal, args)
  exit(ret.result)
if __name__ == '__main__':
  main()
